name: CI

on:
  push:

jobs:
  build-debian-amd64:
    name: Debian (${{ matrix.compiler }}) - amd64
    runs-on: ubuntu-latest
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]

    container:
      image: debian:unstable-slim

    steps:
      - name: Install dependencies
        run: |
          apt-get update -y
          apt-get install -y wget curl cmake make pkgconf clang llvm gcc g++ build-essential valgrind libbsd-dev libjemalloc-dev python3 git libzstd-dev libncurses-dev libncursesw5-dev perl stockfish fairy-stockfish
          rm -rf /var/lib/apt/lists/*
          echo "/usr/games" >> $GITHUB_PATH

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache syzygy tablebases
        uses: actions/cache@v4
        with:
          path: external/syzygy
          key: syzygy-v1

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: cargo-debian-${{ matrix.compiler }}-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: cargo-debian-${{ matrix.compiler }}-

      - name: Set compiler
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            echo "CC=gcc" >> $GITHUB_ENV
            echo "CXX=g++" >> $GITHUB_ENV
          else
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXX=clang++" >> $GITHUB_ENV
          fi

      - name: Build (without PGO)
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DOPTION_SUPPORT_PGO=disabled
          cmake --build build

      - name: Test
        run: python3 scripts/perft_test.py build

      - name: Build (with PGO)
        run: |
          rm -rf build
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build

      - name: Cargo build (release)
        run: cargo build --release --locked
        working-directory: rust

      - name: Cargo test (release)
        run: cargo test --release --lib
        working-directory: rust
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/build

  build-void-amd64:
    name: Void Linux (${{ matrix.compiler }}) - amd64
    runs-on: ubuntu-latest
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache syzygy tablebases
        uses: actions/cache@v4
        with:
          path: external/syzygy
          key: syzygy-v1

      - name: Build in Void Linux container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace \
            ghcr.io/void-linux/void-musl-busybox:latest \
            sh -c '
              set -ex
              xbps-install -Syu
              xbps-install -Sy wget bash cmake make pkg-config clang gcc base-devel llvm libbsd-devel jemalloc-devel python3 git libzstd-devel ncurses-devel perl stockfish fairy-stockfish
              export PATH="$PATH:/usr/games"
              if [ "${{ matrix.compiler }}" = "gcc" ]; then
                export CC=gcc CXX=g++
              else
                export CC=clang CXX=clang++
              fi
              cmake -B build -DCMAKE_BUILD_TYPE=Release -DOPTION_SUPPORT_PGO=disabled
              cmake --build build
              python3 scripts/perft_test.py build
              rm -rf build
              cmake -B build -DCMAKE_BUILD_TYPE=Release
              cmake --build build
            '

  build-debian-arm64:
    name: Debian (${{ matrix.compiler }}) - arm64
    runs-on: ubuntu-24.04-arm
    needs: build-debian-amd64
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]

    container:
      image: debian:unstable-slim

    steps:
      - name: Install dependencies
        run: |
          apt-get update -y
          apt-get install -y wget cmake make pkgconf clang llvm gcc g++ build-essential valgrind libbsd-dev libjemalloc-dev python3 git libzstd-dev libncurses-dev libncursesw5-dev perl stockfish fairy-stockfish
          rm -rf /var/lib/apt/lists/*
          echo "/usr/games" >> $GITHUB_PATH

      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache syzygy tablebases
        uses: actions/cache@v4
        with:
          path: external/syzygy
          key: syzygy-v1

      - name: Set compiler
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            echo "CC=gcc" >> $GITHUB_ENV
            echo "CXX=g++" >> $GITHUB_ENV
          else
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXX=clang++" >> $GITHUB_ENV
          fi

      - name: Build (without PGO)
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DOPTION_SUPPORT_PGO=disabled
          cmake --build build

      - name: Test
        run: python3 scripts/perft_test.py build

      - name: Build (with PGO)
        run: |
          rm -rf build
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build

  build-void-arm64:
    name: Void Linux (${{ matrix.compiler }}) - arm64
    runs-on: ubuntu-24.04-arm
    needs: build-void-amd64
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache syzygy tablebases
        uses: actions/cache@v4
        with:
          path: external/syzygy
          key: syzygy-v1

      - name: Build in Void Linux container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace \
            ghcr.io/void-linux/void-musl-busybox:latest \
            sh -c '
              set -ex
              xbps-install -Syu
              xbps-install -Sy wget bash cmake make pkg-config clang gcc base-devel llvm libbsd-devel jemalloc-devel python3 git libzstd-devel ncurses-devel perl stockfish fairy-stockfish
              export PATH="$PATH:/usr/games"
              if [ "${{ matrix.compiler }}" = "gcc" ]; then
                export CC=gcc CXX=g++
              else
                export CC=clang CXX=clang++
              fi
              cmake -B build -DCMAKE_BUILD_TYPE=Release -DOPTION_SUPPORT_PGO=disabled
              cmake --build build
              python3 scripts/perft_test.py build
              rm -rf build
              cmake -B build -DCMAKE_BUILD_TYPE=Release
              cmake --build build
            '

  build-macos:
    name: macOS
    runs-on: macos-latest
    needs: build-debian-amd64
    timeout-minutes: 180
    steps:
      - name: Install dependencies
        run: |
          brew install cmake make pkg-config libbsd jemalloc python3 git zstd ncurses stockfish fairy-stockfish gsed
          brew link zstd jemalloc libbsd stockfish git ncurses fairy-stockfish gsed --overwrite -f

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache syzygy tablebases
        uses: actions/cache@v4
        with:
          path: external/syzygy
          key: syzygy-v1

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: cargo-macos-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: cargo-macos-

      - name: Setup Homebrew paths
        run: |
          BREW_PREFIX=$(brew --prefix)
          echo "PKG_CONFIG_PATH=$BREW_PREFIX/lib/pkgconfig:$BREW_PREFIX/opt/jemalloc/lib/pkgconfig" >> $GITHUB_ENV
          echo "LIBRARY_PATH=$BREW_PREFIX/lib:$BREW_PREFIX/opt/jemalloc/lib" >> $GITHUB_ENV
          echo "CPATH=$BREW_PREFIX/include:$BREW_PREFIX/opt/jemalloc/include" >> $GITHUB_ENV
          echo "CMAKE_PREFIX_PATH=$BREW_PREFIX;$BREW_PREFIX/opt/jemalloc" >> $GITHUB_ENV

      - name: Build (without PGO)
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DOPTION_SUPPORT_PGO=disabled -DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH"
          cmake --build build

      - name: Test
        run: python3 scripts/perft_test.py build

      - name: Build (with PGO)
        run: |
          rm -rf build
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH"
          cmake --build build

      - name: Cargo build (release)
        run: cargo build --release
        working-directory: rust

      - name: Cargo test (release)
        run: cargo test --release --lib
        working-directory: rust
        env:
          DYLD_LIBRARY_PATH: ${{ github.workspace }}/build

  build-freebsd-amd64:
    name: FreeBSD (${{ matrix.compiler }}) - amd64
    runs-on: ubuntu-latest
    needs: build-debian-amd64
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache syzygy tablebases
        uses: actions/cache@v4
        with:
          path: external/syzygy
          key: syzygy-v1

      - name: Build in FreeBSD VM
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          prepare: |
            pkg install -y wget bash gsed cmake gmake pkgconf llvm gcc git python3 zstd ncurses perl5 stockfish
          run: |
            set -ex
            if [ "${{ matrix.compiler }}" = "gcc" ]; then
              export CC=gcc CXX=g++
            else
              export CC=clang CXX=clang++
            fi
            export MAKE=gmake
            cmake -B build -DCMAKE_BUILD_TYPE=Release -DOPTION_SUPPORT_PGO=disabled
            cmake --build build
            PYTHONPATH=scripts python3 -c "import sys; sys.argv=['', 'build']; from perft_test import check_traditional; check_traditional()"
            rm -rf build
            cmake -B build -DCMAKE_BUILD_TYPE=Release
            cmake --build build
