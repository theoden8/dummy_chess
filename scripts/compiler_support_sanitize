#!/usr/bin/env bash

CXX="$1"; shift
[ -z "${CXX}" ] && {
  CXX=c++
}

# https://wiki.musl-libc.org/open-issues
if ! echo -e "#include <features.h>
#if !defined(__GLIBC__) && !defined(__APPLE__)
#error no glibc
#endif
int main(){}" | "${CXX}" -x c++ - -o /dev/null 2>/dev/null; then
  echo "disabled"
  exit 0
fi

# https://man.openbsd.org/clang-local.1
if test "$(uname -s)" = 'OpenBSD'; then
  echo "minimal"
  exit 0
fi

# Check ASan support (static first, then dynamic)
ASAN=""
if echo "int main(){}" | "${CXX}" -x c++ - -fsanitize=address -static-libasan -o /dev/null 2>/dev/null; then
  ASAN="asan-static"
elif echo "int main(){}" | "${CXX}" -x c++ - -fsanitize=address -o /dev/null 2>/dev/null; then
  ASAN="asan-dynamic"
fi

# Check UBSan support (static first, then dynamic)
UBSAN=""
if echo "int main(){}" | "${CXX}" -x c++ - -fsanitize=undefined -static-libubsan -o /dev/null 2>/dev/null; then
  UBSAN="ubsan-static"
elif echo "int main(){}" | "${CXX}" -x c++ - -fsanitize=undefined -o /dev/null 2>/dev/null; then
  UBSAN="ubsan-dynamic"
fi

# Output result
if [ -n "${ASAN}" ] && [ -n "${UBSAN}" ]; then
  echo "${ASAN}+${UBSAN}"
elif [ -n "${ASAN}" ]; then
  echo "${ASAN}"
elif [ -n "${UBSAN}" ]; then
  echo "${UBSAN}"
else
  echo "disabled"
fi
